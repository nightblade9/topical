<div id="main">
    <form onsubmit="onSearch(); return false // don't postback">
        <label for="query">Search:</label>
        <input id="query" type="text" />
        <input type="submit" value="Search">
    </form>

    <label id="output" />
</div>

<script type="text/javascript">
    // TODO: externailze in .js file
    setContent = (html) => {
        document.getElementById("output").innerHTML = html;
    }

    main = () => {
        var queryParameters = location.search.slice(1).split("&");
        for (var i = 0; i < queryParameters.length; i++)
        {
            var params = queryParameters[i].split('=');
            var key = params[0];
            var value = params[1];
            if (key.toLowerCase() == "query") {
                // Make sure the document is ready and window.data is defined, before proceeding.
                document.addEventListener("DOMContentLoaded", (event) => {
                    this.onSearch(value);
                });
                break;
            }
        }
    }

    onSearch = (searchQuery) => {
        if (searchQuery == null)
        {
            // came from a form submission, not a parameter
            searchQuery = document.getElementById("query").value;
        }
        
        searchQuery = decodeURI(searchQuery);
        document.getElementById("query").value = searchQuery;

        var allData = JSON.parse(window.data);

        // Too hard/complicated to write as a single lambda/filter
        var matchingItems = [];
        for (var i = 0; i < allData.length; i++)
        {
            var item = allData[i];
            var tags = item["tags"];
            for (var j = 0; j < tags.length; j++)
            {
                if (tags[j].toLowerCase() == searchQuery.toLowerCase())
                {
                    matchingItems.push(item);
                    break;
                }
            }
        }
        
        var finalHtml = "";
        for (var i = 0; i < matchingItems.length; i++)
        {
            var item = matchingItems[i];

            var tagsHtml = "";
            for (var j = 0; j < tags.length; j++)
            {
                // Search page is always in root dir, so absolute path is not necessary here
                tagsHtml += "<span class='tag'><a href='tags/" + tags[j] + ".html" + "'>" + tags[j] + "</a></span>"
            }
            
            // NB: keep in synch with server-side rendering (themer.py / _get_snippet_html)
            finalHtml += `
            <div class='snippet'>
                <h1>{title}</h1>
                <p class='url'>{url}</p>
                <p>{tags}</p>
                <p>{blurb}</p>
            </div>`.replace("{title}", '<a href="' + item["url"] + '">' + item["title"] + "</a>")
                .replace("{url}", '<a href="' + item["url"] + '">' + item["url"] + "</a>")
                .replace("{tags}", tagsHtml)
                .replace("{blurb}", item["blurb"]);
        }
        setContent(finalHtml);
    }

    main();

</script>